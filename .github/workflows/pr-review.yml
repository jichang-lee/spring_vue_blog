name: PR Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - develop

jobs:
  backend-review:
    name: Backend Code Review
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          
      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2
      
      - name: Run Checkstyle
        id: checkstyle
        continue-on-error: true
        run: ./gradlew checkstyleMain checkstyleTest
      
      - name: Run SpotBugs
        id: spotbugs
        continue-on-error: true
        run: ./gradlew spotbugsMain
      
      - name: Run PMD
        id: pmd
        continue-on-error: true
        run: ./gradlew pmdMain
      
      - name: Generate Backend Review Comment
        id: backend-review
        run: |
          echo "### ë°±ì—”ë“œ ì½”ë“œ ë¦¬ë·° ê²°ê³¼ ğŸ“" > backend-review.md
          echo "" >> backend-review.md
          
          # Checkstyle ê²°ê³¼ í™•ì¸
          if [ "${{ steps.checkstyle.outcome }}" == "success" ]; then
            echo "âœ… **Checkstyle**: ëª¨ë“  ì½”ë”© ìŠ¤íƒ€ì¼ ê·œì¹™ì„ ì¤€ìˆ˜í•˜ê³  ìˆìŠµë‹ˆë‹¤." >> backend-review.md
          else
            echo "âŒ **Checkstyle**: ì½”ë”© ìŠ¤íƒ€ì¼ ê·œì¹™ ìœ„ë°˜ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤." >> backend-review.md
            echo "```" >> backend-review.md
            if [ -f "build/reports/checkstyle/main.html" ]; then
              cat build/reports/checkstyle/main.txt | head -20 >> backend-review.md
              echo "..." >> backend-review.md
            else
              echo "ë¦¬í¬íŠ¸ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." >> backend-review.md
            fi
            echo "```" >> backend-review.md
          fi
          
          # SpotBugs ê²°ê³¼ í™•ì¸
          if [ "${{ steps.spotbugs.outcome }}" == "success" ]; then
            echo "âœ… **SpotBugs**: ì ì¬ì ì¸ ë²„ê·¸ê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤." >> backend-review.md
          else
            echo "âŒ **SpotBugs**: ì ì¬ì ì¸ ë²„ê·¸ê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤." >> backend-review.md
            echo "ìì„¸í•œ ë‚´ìš©ì€ SpotBugs ë¦¬í¬íŠ¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”." >> backend-review.md
          fi
          
          # PMD ê²°ê³¼ í™•ì¸
          if [ "${{ steps.pmd.outcome }}" == "success" ]; then
            echo "âœ… **PMD**: ì½”ë“œ í’ˆì§ˆ ì´ìŠˆê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤." >> backend-review.md
          else
            echo "âŒ **PMD**: ì½”ë“œ í’ˆì§ˆ ì´ìŠˆê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤." >> backend-review.md
            echo "```" >> backend-review.md
            if [ -f "build/reports/pmd/main.html" ]; then
              cat build/reports/pmd/main.txt | head -20 >> backend-review.md
              echo "..." >> backend-review.md
            else
              echo "ë¦¬í¬íŠ¸ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." >> backend-review.md
            fi
            echo "```" >> backend-review.md
          fi
          
          echo "" >> backend-review.md
          echo "### ê°œì„  ì œì•ˆ ğŸ’¡" >> backend-review.md
          echo "- ë©”ì„œë“œ ê¸¸ì´: ë©”ì„œë“œëŠ” ê°€ëŠ¥í•œ 20ì¤„ ì´ë‚´ë¡œ ì‘ì„±í•˜ì„¸ìš”." >> backend-review.md
          echo "- ì£¼ì„: ëª¨ë“  public ë©”ì„œë“œì™€ í´ë˜ìŠ¤ì— JavaDoc ì£¼ì„ì„ ì¶”ê°€í•˜ì„¸ìš”." >> backend-review.md
          echo "- ë³€ìˆ˜ëª…: ë³€ìˆ˜ëª…ì€ ì¹´ë©œ ì¼€ì´ìŠ¤ë¡œ ì‘ì„±í•˜ê³  ì˜ë¯¸ìˆëŠ” ì´ë¦„ì„ ì‚¬ìš©í•˜ì„¸ìš”." >> backend-review.md
          echo "- í…ŒìŠ¤íŠ¸: ëª¨ë“  ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì— ëŒ€í•œ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë¥¼ ì‘ì„±í•˜ì„¸ìš”." >> backend-review.md
          
          cat backend-review.md

      - name: Post Backend Review Comment
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const reviewContent = fs.readFileSync('backend-review.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: reviewContent
            });

  frontend-review:
    name: Frontend Code Review
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'front/package-lock.json'
          
      - name: Install Dependencies
        run: cd front && npm install
      
      - name: Run ESLint
        id: eslint
        continue-on-error: true
        run: cd front && npm run lint || true
      
      - name: Run Vue Style Lint
        id: stylelint
        continue-on-error: true
        run: cd front && npm run stylelint || true
      
      - name: Generate Frontend Review Comment
        id: frontend-review
        run: |
          echo "### í”„ë¡ íŠ¸ì—”ë“œ ì½”ë“œ ë¦¬ë·° ê²°ê³¼ ğŸ“" > frontend-review.md
          echo "" >> frontend-review.md
          
          # ESLint ê²°ê³¼ í™•ì¸
          if [ "${{ steps.eslint.outcome }}" == "success" ]; then
            echo "âœ… **ESLint**: JavaScript/Vue ì½”ë“œ ìŠ¤íƒ€ì¼ ê·œì¹™ì„ ì¤€ìˆ˜í•˜ê³  ìˆìŠµë‹ˆë‹¤." >> frontend-review.md
          else
            echo "âŒ **ESLint**: JavaScript/Vue ì½”ë“œ ìŠ¤íƒ€ì¼ ìœ„ë°˜ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤." >> frontend-review.md
            echo "```" >> frontend-review.md
            cd front && npx eslint --format unix 'src/**/*.{js,vue}' | head -20 >> ../frontend-review.md || echo "ESLint ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." >> ../frontend-review.md
            echo "..." >> ../frontend-review.md
            echo "```" >> ../frontend-review.md
          fi
          
          # StyleLint ê²°ê³¼ í™•ì¸
          if [ "${{ steps.stylelint.outcome }}" == "success" ]; then
            echo "âœ… **StyleLint**: CSS/SCSS ìŠ¤íƒ€ì¼ ê·œì¹™ì„ ì¤€ìˆ˜í•˜ê³  ìˆìŠµë‹ˆë‹¤." >> frontend-review.md
          else
            echo "âŒ **StyleLint**: CSS/SCSS ìŠ¤íƒ€ì¼ ìœ„ë°˜ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤." >> frontend-review.md
          fi
          
          echo "" >> frontend-review.md
          echo "### ê°œì„  ì œì•ˆ ğŸ’¡" >> frontend-review.md
          echo "- ì»´í¬ë„ŒíŠ¸ í¬ê¸°: ê° ì»´í¬ë„ŒíŠ¸ëŠ” ê°€ëŠ¥í•œ 300ì¤„ ì´ë‚´ë¡œ ì‘ì„±í•˜ì„¸ìš”." >> frontend-review.md
          echo "- Props ê²€ì¦: ëª¨ë“  propsì— íƒ€ì…ê³¼ í•„ìˆ˜ ì—¬ë¶€ë¥¼ ëª…ì‹œí•˜ì„¸ìš”." >> frontend-review.md
          echo "- ëª…ëª… ê·œì¹™: ì»´í¬ë„ŒíŠ¸ ì´ë¦„ì€ PascalCase, ë©”ì„œë“œ ì´ë¦„ì€ camelCaseë¡œ ì‘ì„±í•˜ì„¸ìš”." >> frontend-review.md
          echo "- ì£¼ì„: ë³µì¡í•œ ë¡œì§ì—ëŠ” ì£¼ì„ì„ ì¶”ê°€í•˜ì„¸ìš”." >> frontend-review.md
          
          cat frontend-review.md

      - name: Post Frontend Review Comment
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const reviewContent = fs.readFileSync('frontend-review.md', 'utf8');
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: reviewContent
            });

  summary-review:
    name: Summary Review
    needs: [backend-review, frontend-review]
    runs-on: ubuntu-latest
    steps:
      - name: Post Summary Comment
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## PR ì½”ë“œ ë¦¬ë·° ìš”ì•½ ğŸ“Š

              ì´ PRì— ëŒ€í•œ ìë™ ì½”ë“œ ë¦¬ë·°ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ê° ì˜ì—­ë³„ ìƒì„¸ ë¦¬ë·° ê²°ê³¼ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.
              
              ### ê°œë°œì ì²´í¬ë¦¬ìŠ¤íŠ¸ âœ“
              - [ ] ë°±ì—”ë“œ ì½”ë“œ ì»¨ë²¤ì…˜ì„ ì¤€ìˆ˜í–ˆëŠ”ì§€ í™•ì¸
              - [ ] í”„ë¡ íŠ¸ì—”ë“œ ì½”ë“œ ì»¨ë²¤ì…˜ì„ ì¤€ìˆ˜í–ˆëŠ”ì§€ í™•ì¸
              - [ ] í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì‘ì„±í–ˆëŠ”ì§€ í™•ì¸
              - [ ] ì½”ë“œ ë¦¬ë·° ê²°ê³¼ì— ë”°ë¼ ìˆ˜ì •ì‚¬í•­ì„ ë°˜ì˜í–ˆëŠ”ì§€ í™•ì¸
              
              ì½”ë“œ ë¦¬ë·° ê²°ê³¼ì— ë¬¸ì œê°€ ìˆëŠ” ê²½ìš°, ìˆ˜ì • í›„ ë‹¤ì‹œ ì»¤ë°‹í•´ì£¼ì„¸ìš”.`
            });
